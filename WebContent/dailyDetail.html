<!DOCTYPE html>
<html>
 <head>
  	<meta charset="UTF-8">
  	<link href="main.css" type="text/css" rel="stylesheet">
  	<link href="hobbyDetail.css" type="text/css" rel="stylesheet">
    <title>WWH</title>
    <script src="//developers.kakao.com/sdk/js/kakao.min.js"></script>
    <script src="key.js"></script>
    <script>
    	
	    function getURLParams(url) {
			var result = {};
			url.replace(/[?&]{1}([^=&#]+)=([^&#]*)/g, function(s, k, v) { result[k] = decodeURIComponent(v); });
			return result;
		}
		const index = getURLParams(location.search).post_id;
	    console.log(index);
	    
	    var postArr = JSON.parse(localStorage.getItem('postDaily'));
	    var post = null, arrIndex=null;
	    for(i=0; i<postArr.length; i++) {
	    	if(postArr[i].index == index) {
	    		post = postArr[i];
	    		arrIndex = i;
	    	}
	    }
	    function display () {
	    	if(post.comments.length<0) return;
	    	console.log(post)
			var divtag = "";
			for(i=0; i<post.comments.length; i++) {
				nickname = post.comments[i].writer;
				content = post.comments[i].content;
				divtag = "<div class='comment'><div class='comment-wrtier'>"+nickname+"</div><div class='comment-content'>"+content+"</div></div>";
				document.write(divtag);
			}
		}
	    
	    var button = "";
    	var userArr = JSON.parse(localStorage.getItem('user'));
    	//로그인되어 있는 유저체크 필요
    	var likeArr = userArr[0].like;
    	var state = false;
    	var likeIndex = -1;
	    function likeButton() {
	    	if(likeArr.length>0) {
	    		for(i=0; i<likeArr.length; i++) {
		    		if(likeArr[i].type == "daily" && likeArr[i].index == index) {
		    			state = true;
		    			likeIndex = i;
		    		}
		    	}
	    	}
	    	
	    	if(state) {
	    		button = "<button onclick='likeHandler()' style='border:0; outline:0; background-color:transparent;'><img id='heart' src='source/heart-full.png' width=40 height=40/></button>"
	    	}
	    	else {
	    		button = "<button onclick='likeHandler()' style='border:0; outline:0; background-color:transparent;'><img id='heart' src='source/heart-empty.png' width=40 height=40/></button>"
	    	}
	    	document.write(button);
	    }
	    
	    function likeHandler() {
	    	var temp = {
	    			type: 'daily',
	    			index: index
	    	}
	    	if(state) {
	    		document.getElementById('heart').src = 'source/heart-empty.png'
	    		state = false;
	    		userArr[0].like.splice(likeIndex, 1);
	    	}
	    	else {
	    		document.getElementById('heart').src = 'source/heart-full.png'
	    		state = true;
	    		userArr[0].like.push(temp);
	    	}
	    	
	    	localStorage.setItem('user', JSON.stringify(userArr));
	    }
	    
	    function postComment(e) {
	    	e.preventDefault();
	    	const url = window.location.href;
	    	var content = document.getElementById('content').value;
	    	if(!content) { alert("내용을 입력해주세요!"); return; }
	    	console.log(post)
	    	var commentArr = post.comments;
	    	console.log(commentArr);
	    	
	    	var comment = {
	    			writer: 'sungeun', //나중에 현재 로그인된 아이디로 수정 필요
	    			content: content,
	    	}
	    	console.log(comment);
	    	commentArr.push(comment);
	    	postArr[arrIndex].comments = commentArr;
	    	localStorage.setItem('postDaily', JSON.stringify(postArr));
	    	window.location.replace(url);
	    }
    </script>
 </head>
<body>
<header>
    <h1><span><a href="/">WWH</a></span></h1>
    <nav>
	<ul>
		<li><a href="hobby.html"> 취미 </a></li>
		<li><a href="daily.html"> 일상 </a></li>
		<li><a href="suggest.html"> 건의사항 </a></li>
		<li><a href="#"> 마이페이지 </a></li>
		<li style="font-size:22px; margin-top:5px;"><a href="login.html"> 로그인 </a></li>
	</ul>
</nav>
</header>

<section>
	<article class="hobby">
	<h2 class="title">일상 | <span style="font-size:25px">일상의 이야기를 나누는 공간</span></h2>
		<div class="post-title" id="post-title">title</div> 
		<div style="margin-bottom:20px">
			<span id="post-writer">writer</span> | <span id="post-date">date</span>
		</div>
		<hr/>
		<br/>
		<img id="post-image" width="60%" height="50%" src=""/>
		<div id="post-content">content</div>
		<br/>
	   	<hr/>
	   	<br/>
		<div class="buttons">
		   	<span>
			   	<script>
			   		likeButton();
			   	</script>
		   	</span>
			<span class="kakao-share" id="kakao-link-btn">
				<img src="//developers.kakao.com/assets/img/about/logos/kakaolink/kakaolink_btn_medium.png" width=40 height=40>
				<span style="font-weight:bold; margin-left:5px;">공유하기</span>
			</span>
		</div>
   	</article>
   	
   	<article class="hobby">
		<div>댓글</div>
		<form onsubmit="postComment(event)" style="margin:20px 0"> 
		<textarea id="content" style="width:100%; height:50px"></textarea>
		<button type="submit" style="float:right">작성</button>
		</form>
		
		<div class="comment" >
			<script>display();</script>
		</div>
   	</article>
</section>

<script>
    	var dateArr = post.date.split('T');
	    var timeArr = dateArr[1].split(':');
	    
	    document.getElementById('post-title').innerHTML = post.title;
	    document.getElementById('post-writer').innerHTML = post.writer;
	    document.getElementById('post-date').innerHTML = dateArr[0]+"-"+timeArr[0]+":"+timeArr[1];
	    document.getElementById('post-image').src = post.image;
	    document.getElementById('post-content').innerHTML = post.content;
	    
	    if(window.Kakao) {
	    	const kakao = window.Kakao
	    	
	    	if(!kakao.isInitailized) {
	    		kakao.init(getKey());
	    	}
		    
		    kakao.Link.createDefaultButton({
		    	container:'#kakao-link-btn',
		    	objectType: 'feed',
		    	content:{
		    		title:'카카오톡 공유 테스트',
		    		description: '#취미 #집콕 #실내취미 #공유',
		    		imageUrl: '',
		    		link: {
		    			mobileWebUrl: 'http://localhost8080',
		    			webUrl: 'http://localhost8080'
		    		}
		    	},
		    	buttons : [
		    		{
			    		title : '웹으로 보기',
			    		link: {
			    			mobileWebUrl: 'http://localhost8080',
			    			webUrl: 'http://localhost8080'
			    		},
		    		},
		    	]
		    })
	    }
	    
    </script>
 <footer>
 	<p>Copyright 2021 by SungEun</p>
 </footer>
</body>
</html>